#!/bin/sh
#
# build
# Copyright Â© 2017 Matej Kosiarcik. All rights reserved.
# This file builds project
#

# setup
set -euf
cd "$(dirname "${0}")/.."
. "./util/helpers.sh"

# parse arguments
configuration="debug"
while getopts "hc:" argument; do
    case "${argument}" in
        c) configuration="${OPTARG}" ;;
    esac
done

# validate arguments
if [ "${configuration}" != "debug" ] && [ "${configuration}" != "release" ]; then
    printf "%s\n" "Unrecognized mode: '${configuration}'"
    exit 1
fi

# prepare output directory
output="./build/${configuration}"
rm -rf "${output}" && mkdir -p "${output}"
find "./src/pages" -type d -depth 1 | while IFS= read -r directory; do
    mkdir -p "${output}/$(basename "${directory}")"
done

# Markup
python3 "./util/build-markup.py" --output "${output}"

# Styles
find "./src/pages" -type f -name "style.scss" | while IFS= read -r file; do
    target="${output}/$(printf "%s\n" "${file}" | sed "s~./src/pages/~~")"
    target="$(dirname "${target}")/$(basename "${target}" ".scss").css"
    sass --scss --unix-newlines "${file}" "${target}"
    printf "%s\n" "$(cssbeautify "${target}")" >"${target}"
done

# Create symlinks from index to home
find "./build/${configuration}/home" -type f | while IFS= read -r file; do
    name="$(basename "${file}")"
    ln -s "home/${name}" "${output}/${name}"
done

# Correct whitespace in generated files
find "./build/${configuration}" -type f | while IFS= read -r file; do
    strip "${file}"
done
